# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
COPY prisma ./prisma/

RUN npm config set fetch-timeout 60000 && \
    npm config set registry https://registry.npmjs.org/ && \
    npm ci

COPY tsconfig.json ./
COPY src ./src/

RUN npx prisma generate && \
    npm run build

# Production stage
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
COPY prisma ./prisma/

RUN npm config set fetch-timeout 60000 && \
    npm config set registry https://registry.npmjs.org/ && \
    npm ci --omit=dev && \
    npx prisma generate

COPY --from=builder /app/dist ./dist/
COPY docker-entrypoint.sh ./

RUN chmod +x docker-entrypoint.sh && \
    mkdir -p /app/data && chown -R node:node /app

USER node

EXPOSE 3001

ENTRYPOINT ["./docker-entrypoint.sh"]
